# CPSU Virtual Health Assistant - Rasa Chatbot

AI-powered conversational interface for symptom reporting and health assessment.

## ğŸ¯ Features

- **Medical NLP**: Recognizes 132+ symptoms with synonyms and variations
- **Django Integration**: Calls Django ML API for disease prediction
- **Emergency Detection**: Identifies critical symptoms requiring immediate care
- **Multi-turn Conversations**: Natural symptom collection flow
- **LLM-validated Results**: Hybrid ML+LLM predictions with 90-98% accuracy

---

## ğŸš€ Quick Start

### 1. Install Dependencies

```bash
cd Rasa
pip install -r requirements.txt
```

### 2. Train the Model

```bash
rasa train
```

This creates a trained model in `models/` directory (~2-3 minutes).

### 3. Start Django Backend (Required!)

```bash
# In a separate terminal
cd ../Django
python manage.py runserver  # Must be running on http://localhost:8000
```

### 4. Start Rasa Action Server

```bash
# In another terminal
cd Rasa
rasa run actions
```

This starts the action server on port 5055.

### 5. Start Rasa Chatbot

```bash
rasa run --enable-api --cors "*"
```

Chatbot is now running on http://localhost:5005

---

## ğŸ’¬ Testing Conversations

### Interactive Shell

```bash
rasa shell
```

Try these examples:

```
You: Hi
Bot: Hello! I'm the CPSU Virtual Health Assistant...

You: I have fever and cough
Bot: I've noted: fever, cough

You: I also feel tired
Bot: I've noted: tired
Bot: Let me confirm - you're experiencing: fever, cough, fatigue. Is that correct?

You: yes
Bot: Thank you. Let me analyze your symptoms...
Bot: ğŸ¥ **Diagnosis Analysis**
     **Condition**: Common Cold
     **Confidence**: 87% âœ… (AI Validated)
     ...
```

### Test via API

```bash
curl -X POST http://localhost:5005/webhooks/rest/webhook \
  -H "Content-Type: application/json" \
  -d '{
    "sender": "test-user",
    "message": "I have fever, cough, and headache"
  }'
```

---

## ğŸ“š Symptom Recognition

The chatbot recognizes **132 symptoms** with multiple synonyms. Examples:

| User Says | Recognized As |
|-----------|---------------|
| "I have a high temperature" | `fever` |
| "My head is pounding" | `headache` |
| "I'm throwing up" | `vomiting` |
| "Stomach hurts" | `abdominal_pain` |
| "Can't breathe well" | `breathlessness` |
| "Body aches" | `muscle_pain` |

See `data/nlu.yml` for complete synonym mappings.

---

## ğŸ—ï¸ Architecture

```
User Message
    â†“
Rasa NLU (Intent + Entity Extraction)
    â†“
Rasa Core (Dialogue Management)
    â†“
Custom Actions (actions.py)
    â†“
Django ML API (http://localhost:8000/api/rasa/predict/)
    â†“
Hybrid ML + LLM Prediction
    â†“
Response to User
```

---

## ğŸ“ File Structure

```
Rasa/
â”œâ”€â”€ config.yml              # NLU & Core configuration (optimized for medical domain)
â”œâ”€â”€ domain.yml              # Intents, entities, slots, responses
â”œâ”€â”€ endpoints.yml           # Action server endpoint (port 5055)
â”œâ”€â”€ credentials.yml         # Channel credentials (REST, Slack, etc.)
â”œâ”€â”€ requirements.txt        # Python dependencies
â”‚
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ nlu.yml            # Training data: intents + 132 symptom synonyms
â”‚   â”œâ”€â”€ stories.yml        # Conversation flows
â”‚   â””â”€â”€ rules.yml          # Rule-based responses (emergency, goodbye, etc.)
â”‚
â”œâ”€â”€ actions/
â”‚   â””â”€â”€ actions.py         # Custom actions (Django integration)
â”‚
â”œâ”€â”€ models/                # Trained models (generated by `rasa train`)
â”‚
â””â”€â”€ tests/
    â””â”€â”€ test_stories.yml   # Conversation tests
```

---

## ğŸ”§ Configuration Details

### NLU Pipeline (`config.yml`)

- **DIETClassifier**: 200 epochs for better medical term recognition
- **EntitySynonymMapper**: Maps symptom variations to canonical names
- **FallbackClassifier**: 60% confidence threshold for safety

### Custom Actions (`actions/actions.py`)

1. **ActionExtractSymptoms**: Extracts and accumulates symptom entities
2. **ActionPredictDisease**: Calls Django ML API with symptoms
3. **ActionProvidePrecautions**: Provides care recommendations
4. **ActionCheckEmergency**: Detects critical symptoms

### Emergency Symptoms

These trigger immediate alert:
- `chest_pain`, `breathlessness`, `coma`, `confusion`
- `weakness_of_one_body_side`, `slurred_speech`
- `acute_liver_failure`, `stomach_bleeding`

---

## ğŸ§ª Development Workflow

### 1. Add New Symptoms

Edit `data/nlu.yml`:

```yaml
- synonym: new_symptom_name
  examples: |
    - user phrase 1
    - user phrase 2
    - common variation
```

### 2. Add New Intents

```yaml
# domain.yml
intents:
  - new_intent_name

# data/nlu.yml
- intent: new_intent_name
  examples: |
    - example 1
    - example 2
```

### 3. Add Conversation Flows

Edit `data/stories.yml`:

```yaml
- story: new conversation flow
  steps:
  - intent: user_intent
  - action: bot_action
```

### 4. Retrain Model

```bash
rasa train
```

### 5. Test Changes

```bash
rasa shell --debug  # See detailed logs
```

---

## ğŸ”Œ Django Integration

Custom actions call Django ML API at `http://localhost:8000/api/rasa/predict/`

**Request:**
```json
{
  "symptoms": ["fever", "cough", "fatigue"],
  "sender_id": "user-session-id",
  "generate_insights": true
}
```

**Response:**
```json
{
  "predicted_disease": "Common Cold",
  "confidence": 0.87,
  "ml_confidence": 0.78,
  "llm_validated": true,
  "description": "...",
  "precautions": ["Rest", "Stay hydrated", ...],
  "is_communicable": false
}
```

See `Django/clinic/rasa_webhooks.py` for API implementation.

---

## ğŸ“Š Training Performance

Expected training times (CPU):
- **NLU Model**: ~60-90 seconds
- **Core Model**: ~30-60 seconds
- **Total**: ~2-3 minutes

Model size: ~50-80 MB

---

## ğŸš¨ Troubleshooting

### "Action server not running"
```bash
# Start action server
rasa run actions
```

### "Django ML API not reachable"
```bash
# Check Django is running
curl http://localhost:8000/api/rasa/predict/

# Start Django if needed
cd Django && python manage.py runserver
```

### "Low confidence predictions"
- Add more training examples to `data/nlu.yml`
- Increase epochs in `config.yml`
- Retrain: `rasa train`

### "Symptom not recognized"
- Add synonym mapping in `data/nlu.yml`
- Retrain model

---

## ğŸ” Production Deployment

### 1. Use Tracker Store (Redis)

```yaml
# endpoints.yml
tracker_store:
  type: redis
  url: localhost
  port: 6379
  db: 0
```

### 2. Secure Action Endpoint

Add authentication between Rasa and Django.

### 3. Deploy with Docker

```bash
# Build Rasa image
docker build -t cpsu-rasa .

# Run with environment variables
docker run -p 5005:5005 \
  -e DJANGO_URL=http://django:8000 \
  cpsu-rasa
```

---

## ğŸ“– Additional Resources

- [Rasa Documentation](https://rasa.com/docs/)
- [NLU Training Data Best Practices](https://rasa.com/docs/rasa/training-data-format)
- [Custom Actions Guide](https://rasa.com/docs/rasa/custom-actions)
- [Django Integration](../Django/docs/api/RASA_INTEGRATION.md)

---

## ğŸ¤ Contributing

When adding features:

1. Update training data (`data/*.yml`)
2. Add custom actions if needed (`actions/actions.py`)
3. Retrain model (`rasa train`)
4. Test conversations (`rasa shell`)
5. Update this README

---

## âœ… Next Steps

- [ ] Train initial model: `rasa train`
- [ ] Test in shell: `rasa shell`
- [ ] Start action server: `rasa run actions`
- [ ] Deploy chatbot: `rasa run --enable-api`
- [ ] Integrate with frontend

---

**Questions?** See `../Django/docs/api/RASA_INTEGRATION.md` for full integration guide.
